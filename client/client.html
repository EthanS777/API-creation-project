<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search through Pokedex!</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>

<body>
    <script>
        // JS

        // handle getting ALL pokemon
        let handleAllResponse = async (form) => {
            const url = form.getAttribute('action');
            const method = form.querySelector("input[name='method']:checked").value;
            const content = document.querySelector('#content');

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Accept': 'application/json'
                }
            });

            // if GET, print the JSON
            if (method === 'GET') {
                const obj = await response.json();
                content.innerHTML = " ";

                // go through each JSON obj, print out info
                obj.forEach(pokemon => {
                    content.innerHTML += `<p>${JSON.stringify(pokemon.id)}- Name: ${pokemon.name}, Type: ${pokemon.type.join(' & ')}, Height: ${pokemon.height}, Weight: ${pokemon.weight}, Weaknesses: ${pokemon.weaknesses.join(' & ')}, Next Evolution: ${pokemon.next_evolution ? pokemon.next_evolution.map(evo => evo.name).join(', ') : 'Nothing'}</p>`;
                })
            }
            // else don't print JSON, just status (HEAD)
            else {
                content.innerHTML = `<h2> Request Received, thanks! Status: ${response.status} </h2>`;
            }
        }

        // handle getting NEXT EVOLUTION
        let handleEvoResponse = async (form) => {
            const url = form.getAttribute('action');
            const method = form.querySelector('input[name="method"]:checked').value;
            const content = document.querySelector("#content");
            let inputName = form.querySelector("#pokemon-name").value;

            let queryUrl = `${url}?name=${inputName}`;

            const response = await fetch(queryUrl, {
                method: method,
                headers: {
                    'Accept': 'application/json',
                },
            });

            // for GET request
            if (method === 'GET') {
                // Pokemon found: print out pokemon and its next evolution
                if (response.status === 200) {
                    const obj = await response.json();
                    content.innerHTML = `<h2>Pokemon: ${obj.name}</h2>
                           <h2>Next Evolution(s): ${obj.next_evolution.map(evo => evo.name).join(', ')}</h2>`;
                } else if (response.status === 404 || response.status === 400) {
                    const errorObj = await response.json();
                    content.innerHTML = `<h2>${errorObj.message}, status: ${response.status}</h2>`;
                }
            } else {
                // HEAD: just show status, no JSON
                response.status === 200
                    ? content.innerHTML = `<h2>Request Received, thanks! Status: ${response.status}</h2>`
                    : content.innerHTML = `<h2>Invalid Request: ${response.status}</h2>`
            }
        }

        // handle getting IMAGE
        let handleImageResponse = async (form) => {
            const url = form.getAttribute('action');
            const method = form.querySelector('input[name="method"]:checked').value;
            const content = document.querySelector("#content");
            let inputName = form.querySelector("#pokemon-name").value;

            const queryUrl = `${url}?name=${inputName}`;

            const response = await fetch(queryUrl, {
                method: method,
                headers: {
                    'Accept': 'application/json'
                }
            });

            // GET request
            if (method === 'GET') {
                if (response.status === 200) {
                    const obj = await response.json();
                    content.innerHTML = `<h2>Pokemon: ${obj.name}</h2> <img src="${obj.image}" />`;
                }
                else if (response.status === 404 || response.status === 400) {
                    const errorObj = await response.json();
                    content.innerHTML = `<h2>${errorObj.message}, status: ${response.status}</h2>`
                }
            }
            // HEAD
            else {
                response.status === 200
                    ? content.innerHTML = `<h2>Request Received, thanks! Status: ${response.status}</h2>`
                    : content.innerHTML = `<h2>Invalid Request: ${response.status}</h2>`
            }
        }

        let handleNameResponse = async (form) => {
            const url = form.getAttribute('action');
            const method = form.querySelector('input[name="method"]:checked').value;
            const content = document.querySelector("#content");
            let inputType = form.querySelector("#pokemon-type").value;
            let inputWeakness = form.querySelector("#pokemon-weakness").value;

            const queryUrl = `${url}?type=${inputType}&weakness=${inputWeakness}`;

            const response = await fetch(queryUrl, {
                method: method,
                headers: {
                    'Accept': 'application/json'
                }
            });

            // vary output based on GET/HEAD
            if (method === 'GET') {
                if (response.status === 200) {
                  const obj = await response.json();
                  content.innerHTML = `<h2>Pokemon Names that fit your search: <br><br>${obj.name.join(", ")}</h2>`;
                }
                else if (response.status === 400 || response.status === 404) {
                  const errorObj = await response.json();
                  content.innerHTML = `<h2>${errorObj.message}, status: ${response.status}</h2>`
                }
            }
            // HEAD
            else {
                response.status === 200
                    ? content.innerHTML = `<h2>Request Received, thanks! Status: ${response.status}</h2>`
                    : content.innerHTML = `<h2>Invalid Request: ${response.status}</h2>`
            }
        };

        let init = () => {
            let getAllForm = document.querySelector("#allForm");
            let getEvolutionForm = document.querySelector("#evolutionForm");
            let getImageForm = document.querySelector("#imageForm");
            let getNameForm = document.querySelector("#nameForm");

            let getForm = (form, func) => (e) => {
                e.preventDefault();
                func(form);
            }

            getAllForm.addEventListener('submit', getForm(getAllForm, handleAllResponse));
            getEvolutionForm.addEventListener('submit', getForm(getEvolutionForm, handleEvoResponse));
            getImageForm.addEventListener('submit', getForm(getImageForm, handleImageResponse));
            getNameForm.addEventListener('submit', getForm(getNameForm, handleNameResponse));
        }

        window.onload = init;
    </script>

    <h1>Pokedex!</h1>

    <!-- Build basic UI -->
    <div id="formSections">
        <h2>Get Next Evolution</h2>
        <form id="evolutionForm" action="/getEvolution" method="GET">
            <label for="pokemon-name">Enter Pokemon Name:</label>
            <input type="text" id="pokemon-name" name="pokemonName">

            <div id="radio-buttons">
                <label><input type="radio" name="method" value="GET" checked> GET</label>
                <label><input type="radio" name="method" value="HEAD"> HEAD</label>
            </div>

            <input type="submit" value="Send Request">
        </form>

        <h2>Get Name</h2>
        <form id="nameForm" action="/getName" method="GET">
            <label for="pokemon-type">Enter Type:</label>
            <input type="text" id="pokemon-type" name="pokemonType"><br>

            <label for="pokemon-weakness">Enter Weakness:</label>
            <input type="text" id="pokemon-weakness" name="pokemonWeakness">

            <div id="radio-buttons">
                <label><input type="radio" name="method" value="GET" checked> GET</label>
                <label><input type="radio" name="method" value="HEAD"> HEAD</label>
            </div>

            <input type="submit" value="Send Request">
        </form>

        <h2>Get All Pokemon!</h2>
        <form id="allForm" action="/getAll" method="GET">
            <div id="radio-buttons">
                <label><input type="radio" name="method" value="GET" checked> GET</label>
                <label><input type="radio" name="method" value="HEAD"> HEAD</label>
            </div>

            <input type="submit" value="Send Request">
        </form>

        <h2>Get Image</h2>
        <form id="imageForm" action="/getImage" method="GET">
            <label for="pokemon-name">Enter Pokemon Name:</label>
            <input type="text" id="pokemon-name" name="pokemonName">
            <div id="radio-buttons">
                <label><input type="radio" name="method" value="GET" checked> GET</label>
                <label><input type="radio" name="method" value="HEAD"> HEAD</label>
            </div>

            <input type="submit" value="Send Request">
        </form>

    </div>

    <div id="content">

    </div>

</body>

</html>